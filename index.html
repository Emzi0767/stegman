<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stegman: Stegman</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Stegman
   </div>
   <div id="projectbrief">Stegman is a small utility for safely encoding files or messages in other files using steganography.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Stegman </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is my project for the conclusion of C programming labs in the 18L semester on the Electronics and Information Technology faculty of Warsaw Institute of Technology.</p>
<h1>Description</h1>
<p>Stegman is a tool that employs cryptography and steganography to safely hide messages in various files. It can also reverse the process to extract information from a file.</p>
<h2>Encoding</h2>
<p>The user has to specify the file in which data will be encoded, a password, and the message to hide. The hiding procedure works as follows:</p>
<ol type="1">
<li>User specifies the password, target file, and either a message or source file for encoding. The target file is the file the data will be encoded into. Source file is equivalent to a message, and it's the data that will be encoded.</li>
<li>Program creates an IV for encryption, by creating a 16-byte array and filling it with data generated by a CSPRNG.</li>
<li>Program creates a salt for hashing, in the same manner as the IV.</li>
<li>Program generates a random number between 32767 and 65535, which determines the number of cycles the password will be hashed.</li>
<li>The program salts the password, hashes it with SHA-256, and repeats the cycle n times (n is the number generated in step 6).</li>
<li>The resulting 256-bit value is then used as key for AES-256 encryption.</li>
<li>The program compresses the plain message using ZLib.</li>
<li>The program encrypts a value of <code>0x0BADFACE</code> as a control value, then the compressed message.</li>
<li>Program loads all the pixels from the source PNG file. If the file is not a 24-bit RGB or 32-bit RGBA image, the program notifies the user and quits.</li>
<li>The program encodes a value of <code>0x0BADFACE</code> into the target image, followed by flags specifying properties of the message, followed by hash cycle count, followed by IV, followed by salt, followed by length of encrypted message, then the encrypted message.</li>
<li>The program rewrites the source PNG file, now containing data encoded in its pixels.</li>
</ol>
<p>The encoding occurs on 2 least significant bits of each color component of each pixel in the target PNG image. So assuming ARGB32-encoded image, it takes 4 channels to encode 1 byte (4 x 2 bits = 8 bits = 1 byte). Thus for ARGB32 images, the final (compressed + encrypted) message can be <code>width * height - 4 - 4 - 2 - 16 - 16 - 8</code> bytes long. This is because:</p>
<ul>
<li><code>0x0BADFACE</code> is a 32-bit integer (4 bytes), used as magic value to determine whether any data is present at all.</li>
<li>The flags are encoded as a 32-bit integer (4 bytes). The documentation for them is available below.</li>
<li>Hash cycle count is a 16-bit unsigned integer (2 bytes).</li>
<li>IV is 16 bytes.</li>
<li>Salt is 16 bytes.</li>
<li>Length is encoded as a 64-bit integer (8 bytes), it does not include padding.</li>
</ul>
<p>The length encoded is without padding. AES-256 encrypts data in 128-bit (16-byte) blocks. This means the encrypted message length will be rounded up to nearby 16. Knowing that, we can encode the length without padding, because we can easily calculate the length of the padded message.</p>
<h2>Decoding</h2>
<p>The user has to specify the PNG file containing a hidden message, and password to decrypt it. The program then attempts to find, identify, and extract the message. If the input message was a file, the user has to specify the output file name. The procedure works as follows:</p>
<ol type="1">
<li>Program loads all pixels from the souce PNG image. If the pixels format is not 24-bit RGB or 32-bit RGBA, the program quits.</li>
<li>Program decodes first 4 bytes, and checks if they equal <code>0x0BADFACE</code>. If they don't, the user is notified that the file does not contain a message and the program exits.</li>
<li>Program decodes the message properties, hash cycle count, IV, salt, and data length.</li>
<li>Program calculates the encrypted length by rounding up length to nearest 16.</li>
<li>Program decodes first 16 bytes of the encrypted message.</li>
<li>Program calculates the encryption key by salting the key, hashing it with SHA-256, and repeating the procedure n times, where n is the hash cycle count.</li>
<li>Program attempts to decrypt the 16 bytes using the AES-256 algorithm, with the IV and key it computed.</li>
<li>If the first 4 bytes of the decoded message are not equal to <code>0x0BADFACE</code>, the user is notified that the password they supplied is invalid, and the program exits.</li>
<li>The program decodes and decrypts the rest of the message.</li>
<li>The program decompresses the decrypted message using ZLib.</li>
<li>The program displays the message, or, if the message was a file, writes it to specified path.</li>
</ol>
<h2>Message Properties</h2>
<p>The 32-bit properties bitfield contains information about the source message. Descriptions of specific bits can be found below:</p>
<table class="doxtable">
<tr>
<th align="left">**Bit** </th><th align="left"><b>Value</b> </th><th align="left"><b>Description</b>  </th></tr>
<tr>
<td align="left">0 </td><td align="left"><code>0x00000001</code> </td><td align="left">The input message was a file </td></tr>
</table>
<h1>Requirements</h1>
<p>The program was designed to work under GNU/Linux environments. It might work under other POSIX-compatible systems, provided appropriate prerequisites are installed, however that is not guaranteed. Furthermore the program was not tested under Windows at all.</p>
<p>Under Debian 10 (Buster) all requirements can be installed by doing:</p>
<div class="fragment"><div class="line">$ sudo apt-get install clang-6.0 lld-6.0 llvm-6.0 libssl-dev zlib1g-dev libpng-dev make build-essential git bash</div></div><!-- fragment --><p>Then you can simply clone this repository, and in its root directory, run <code>CC=clang-6.0 CFLAGS="-O2 -march=native" LDFLAGS=-fuse-ld=lld ./config.sh &amp;&amp; make</code></p>
<h2>Libraries</h2>
<ul>
<li>OpenSSL</li>
<li>ZLib</li>
<li>libpng</li>
</ul>
<h2>Operating System</h2>
<p>Any modern GNU/Linux distribution. The program was written for Debian 10 (Buster), and tester under Debian 9 (Stretch).</p>
<p>Any POSIX-compatible UNIX (such as FreeBSD) might also work.</p>
<h2>Compiler, Linker, Make</h2>
<p>The program was tested to compile with Clang 6.0, and linked with LLD 6.0. However, any C99-capable compiler should do the job.</p>
<p>To build the program, you need a Make implementation available on your system. The program was tested with GNU Make.</p>
<h2>Shell</h2>
<p>The configuration script uses Bashisms extensively, so you need a modern version of Bash installed.</p>
<h1>Using the program</h1>
<p>Using the program is fairly straightforward. It has 2 operation modes: encode and decode.</p>
<p>In below descriptions, <code>&lt;&gt;</code> indicates a required argument, <code>[]</code> indicates an optional one. Do not put the brackets in actual command invocation. E.g. for invocation like <code>./test &lt;arg1&gt; &lt;arg2&gt;</code> you would invoke as <code>./test "asdf" 123</code>.</p>
<h2>Encoding</h2>
<p>To encode a message (or a file) into a file, run the program as:</p>
<p><code>./stegman encode &lt;password&gt; &lt;target file&gt; &lt;message&gt;</code> to encode a text message, or <code>./stegman encode &lt;password&gt; &lt;target file&gt; @&lt;source file&gt;</code> to encode a file.</p>
<table class="doxtable">
<tr>
<th align="left">**Argument** </th><th align="left"><b>Description</b>  </th></tr>
<tr>
<td align="left"><code>password</code> </td><td align="left">The password to secure your data before encoding. </td></tr>
<tr>
<td align="left"><code>target file</code> </td><td align="left">The file in which the data will be encoded. </td></tr>
<tr>
<td align="left"><code>message</code> </td><td align="left">Text message to encode in the file. </td></tr>
<tr>
<td align="left"><code>source file</code> </td><td align="left">File to encode in the file. </td></tr>
</table>
<h2>Decoding</h2>
<p>To decode a message from a file, you would run the program as <code>./stegman decode &lt;password&gt; &lt;source file&gt; [target file]</code>. Note that if source message was a file, you must specify target file.</p>
<table class="doxtable">
<tr>
<th align="left">**Argument** </th><th align="left"><b>Description</b>  </th></tr>
<tr>
<td align="left"><code>password</code> </td><td align="left">The password used to secure your encoded data. </td></tr>
<tr>
<td align="left"><code>source file</code> </td><td align="left">The file in which the data was encoded. </td></tr>
<tr>
<td align="left"><code>target file</code> </td><td align="left">The file in which the decoded data will be placed. </td></tr>
</table>
<h1>License</h1>
<p>The program and the source are shared under MIT License. See LICENSE file for details. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
